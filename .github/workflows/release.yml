name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            TARGET: windows
            ARCH: x86_64
            EXT: .exe
            ASSET_EXT: .zip
          - os: ubuntu-latest
            TARGET: linux
            ARCH: x86_64
            EXT: ""
            ASSET_EXT: .zip
          - os: macos-latest
            TARGET: macos
            ARCH: x86_64
            EXT: ""
            ASSET_EXT: .zip
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build pyinstaller
          pip install -e .
          
      # Build PyPI Package (Only on Linux to avoid duplicates)
      - name: Build Wheel (PyPI)
        if: matrix.os == 'ubuntu-latest'
        run: python -m build

      # Publish to PyPI (Only on Linux)
      - name: Publish to PyPI
        if: matrix.os == 'ubuntu-latest'
        continue-on-error: true
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          pip install twine
          twine upload dist/*.whl dist/*.tar.gz
        
      # Build Standalone Executable
      - name: Build Executable
        run: python build_exe.py

      # Rename and Archive for Tooling Managers
      - name: Prepare Asset
        shell: bash
        run: |
          # Create Archive
          cd dist
          ASSET_NAME="roblox-test-runner-${{ matrix.TARGET }}-${{ matrix.ARCH }}${{ matrix.ASSET_EXT }}"
          
          if [ "${{ matrix.ASSET_EXT }}" == ".zip" ]; then
            if [ "${{ matrix.os }}" == "windows-latest" ]; then
              7z a ../$ASSET_NAME roblox-test-runner${{ matrix.EXT }}
            else
              zip -r ../$ASSET_NAME roblox-test-runner${{ matrix.EXT }}
            fi
          fi

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            roblox-test-runner-${{ matrix.TARGET }}-${{ matrix.ARCH }}${{ matrix.ASSET_EXT }}
            dist/*.whl
            dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
